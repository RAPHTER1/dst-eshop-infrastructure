stages:
  - ssh

image: debian:12-slim

before_script:
  - apt-get update -qy
  - apt-get install -qy --no-install-recommends openssh-client git gettext ansible-core file
  - cd dev/ansible
  - export ANSIBLE_ROLES_PATH="$CI_PROJECT_DIR/dev/ansible/roles"

  - mkdir -p ~/.ssh && chmod 700 ~/.ssh
  - echo "$SSH_KEY" > ~/.ssh/ansible_proxmox
  - chmod 600 ~/.ssh/ansible_proxmox
  - export ANSIBLE_SSH_PRIVATE_KEY_FILE=~/.ssh/ansible_proxmox
  - ssh-keyscan -p "$PROXMOX_HOST_PORT" "$PROXMOX_HOST_IP" >> ~/.ssh/known_hosts
  - echo -e "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
  - chmod 600 ~/.ssh/config
provision:
  stage: ssh
  script:
    - ssh -i "$ANSIBLE_SSH_PRIVATE_KEY_FILE" -p "$PROXMOX_HOST_PORT" ansible@"$PROXMOX_HOST_IP" hostname